<!DOCTYPE html>
<html lang="zh-CN">
  <!-- 头信息，包含标题、Bootstrap 样式表、自定义样式表、Bootstrap 脚本 -->
  <head>
    <meta charset="UTF-8" />
    <title>KMLCLBS - {% block title %}访问统计监控{% endblock %}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/bootstrap.min.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/my.css') }}"
    />
    <script
      src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"
      integrity="sha384-/mhDoLbDldZc3qpsJHpLogda//BVZbgYuw6kof4u2FrCedxOtgRZDTHgHUhOCVim"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <!-- 主体内容，包含导航栏、面包屑导航、表单、消息闪现 -->
  <div class="container-fluid">
    <section class="content">
      {% for message in get_flashed_messages() %}
      <div class="flash">{{ message }}</div>
      {% endfor %}
      <div class="d-flex" style="min-height: 80vh">
        <!-- 侧边栏 -->
        <aside
          class="d-flex flex-column flex-shrink-0 p-3 text-bg-light"
          style="width: 280px; height: 80vh"
        >
          <div
            class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none"
          >
            <img
              class="bi pe-none me-2"
              width="40"
              height="32"
              data-v-8a9e6923=""
              src="data:png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAKkSURBVHgB5ZZNSFRRFMf/594ZnRmZEMOPpAylVExs4cJVi1a1qKCFroSCoKhNtbBFlL4It9GmoKCVLQpdFZQLRcmQiFoFfWiSKETqaIOWOM28ezoFyfTmvXrivNn4h5n73jn3nvc797573gW2ushpWOhuPEps9mXb0gbfHg1O3DnzGmn40Hx3wynFXJ5tM5rHK6zJZ86+oRwi4g7563RQfnkXL70PJJPwIUW4IDGa/4ph8FCaHACFAomBHW72gAA4J24qw2EUAoCtpiJZs7jTHivSSygEQBLpJjYod9oN25PrN+3tOjAABh0moojTrpV+uX7T328HArBk1dUYpvM5DsL3cCw97DYmbwBsQRkOXZPLqlwnj8S7pubdxoWQB81e3Bld5KglqZ50+qSGZNKs7nqN3dQMsCx44uretsi2kiey87pc+4AHK1XVU68YOaU40dPQJ02nw2yMwYBUySGlzYysc5hAzfI7YhitEiTiHp6TsbDdErsyNQsP+V0CpRQ6hLeDjV6nZrcM/vgYKc049q+H/w6MYLQKTe1l1yfG/tcxgDqAaUN8qLzn/WM//fMJsGzI9CrY+yusied+B21yG7K8gzSuiPpWoQZ2WR+WNhrBF4DNPP/p69rBPaWREqU5GrJ1GhqLcaRmyJpewybkC4CZzIM3y59vjs74OpBsRAU7kHgpL6U4W69Ot4ZrqlfaJLMW2LRstH5RYb396NU/rzMw11tbubtqZVgxjYDplkTvI7bHEt31J1AIAP2j+IacBQ4ga2bp19eR1O0Fq64eQQLMXa6tlF153N3LMZjQJQQJINtSMqWolzuVQSOCBNDF4YRk6lkTIkWYRJAA2zPVc9IMuToZGXnQPQQJQNZohmDOEmNMKped5VqVcn2ubAPfh62ln2DB3WXAfTjyAAAAAElFTkSuQmCC"
              class="custom-logo"
            />
            <span class="fs-4">KMLCLBS</span>
          </div>
          <hr />
          <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
              <!-- * home 是蓝图名, index 是 home 蓝图下的 index 函数 --></a>
              <a
                href="{{url_for('home.index')}}"
                class="nav-link text-dark {% if request.endpoint == 'home.index' %}active{% endif %}"
              >
                <svg class="bi pe-none me-2" width="16" height="16">
                  <use xlink:href="#house"></use>
                </svg>
                主页
              </a>
            </li>
            <li class="nav-item">
              <!-- * pcr 是蓝图名, index 是 pcr 蓝图下的 index 函数 -->
              <a
                href="{{url_for('pcr.index')}}"
                class="nav-link text-dark {% if request.endpoint == 'pcr.index' %}active{% endif %}"
              >
                <svg class="bi pe-none me-2" width="16" height="16">
                  <use xlink:href="#home"></use>
                </svg>
                PCR
              </a>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link text-dark">
                <svg class="bi pe-none me-2" width="16" height="16">
                  <use xlink:href="#speedometer2"></use>
                </svg>
                NGS
              </a>
            </li>
            <li class="nav-item">
              <a
                href="{{url_for('monitor.index')}}"
                class="nav-link text-dark active"
              >
                <svg class="bi pe-none me-2" width="16" height="16">
                  <use xlink:href="#bar-chart"></use>
                </svg>
                访问统计
              </a>
            </li>
          </ul>
        </aside>

        <!-- Main content -->
        <main class="flex-grow-1 p-4" style="height: 80vh; overflow: auto">
          <h2>{{ title }}</h2>
          <hr />
          
          <!-- 统计卡片 -->
          <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
            <div class="col">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">总访问次数</h5>
                  <p class="card-text display-4 fw-bold text-primary">{{ total_visits }}</p>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">唯一IP数量</h5>
                  <p class="card-text display-4 fw-bold text-success">{{ unique_ips }}</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 按路径分组的访问次数 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">按路径访问统计</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th scope="col">路径</th>
                      <th scope="col">访问次数</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in visits_by_path %}
                    <tr>
                      <td>{{ item.path }}</td>
                      <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- 按天分组的访问次数 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">按天访问统计</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="visitsByDayChart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- 按小时分组的访问次数 -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">按小时访问统计</h5>
            </div>
            <div class="card-body">
              <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="visitsByHourChart"></canvas>
              </div>
            </div>
          </div>
          
          <script>
            // 按天访问统计图表
            const dayLabels = {{ visits_by_day | map(attribute='day') | list | tojson }};
            const dayCounts = {{ visits_by_day | map(attribute='count') | list | tojson }};
            
            const dayCtx = document.getElementById('visitsByDayChart').getContext('2d');
            new Chart(dayCtx, {
              type: 'line',
              data: {
                labels: dayLabels,
                datasets: [{
                  label: '访问次数',
                  data: dayCounts,
                  borderColor: 'rgba(75, 192, 192, 1)',
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  tension: 0.1,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
            
            // 按小时访问统计图表
            const hourLabels = {{ visits_by_hour | map(attribute='hour') | list | tojson }};
            const hourCounts = {{ visits_by_hour | map(attribute='count') | list | tojson }};
            
            const hourCtx = document.getElementById('visitsByHourChart').getContext('2d');
            new Chart(hourCtx, {
              type: 'bar',
              data: {
                labels: hourLabels,
                datasets: [{
                  label: '访问次数',
                  data: hourCounts,
                  backgroundColor: 'rgba(153, 102, 255, 0.6)',
                  borderColor: 'rgba(153, 102, 255, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: true
                  },
                  x: {
                    title: {
                      display: true,
                      text: '小时'
                    }
                  }
                }
              }
            });
          </script>
        </main>
      </div>
    </section>
  </div>
</html>
