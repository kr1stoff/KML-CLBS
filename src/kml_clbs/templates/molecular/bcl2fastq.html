{% extends 'index.html' %}{% block title %}bcl2fastq{% endblock %} {% block
content %}
<div class="container">
  <h2 class="mb-4">Illumina bcl2fastq 数据拆分</h2>

  <!-- 上传表单 -->
  <form
    method="post"
    action="{{ url_for('molecular.bcl2fastq') }}"
    enctype="multipart/form-data"
    class="mb-4"
  >
    {% if csrf_token is defined %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    {% endif %}

    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label for="chip_id" class="form-label">芯片号</label>
        <input
          type="text"
          class="form-control"
          id="chip_id"
          name="chip_id"
          placeholder="输入芯片号"
          value="{{ request.form.chip_id or '' }}"
        />
      </div>

      <div class="col-md-6">
        <label for="samplesheet" class="form-label">Samplesheet (CSV)</label>
        <input
          class="form-control"
          type="file"
          id="samplesheet"
          name="samplesheet"
          accept=".csv,text/csv"
        />
      </div>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-primary">上传</button>
      <button type="reset" class="btn btn-outline-secondary ms-2">重置</button>
      <small class="text-muted ms-3">仅支持 CSV 格式</small>
    </div>
  </form>

  <hr class="my-4" />

  {% set headers = ['芯片号', '下机时间', '拆分状态', '操作'] %}

  <!-- 搜索栏 -->
  <div class="row mb-2">
    <div class="col-md-4">
      <label for="table-search" class="form-label visually-hidden">搜索</label>
      <input
        id="table-search"
        class="form-control"
        placeholder="搜索（支持芯片号/时间/状态）"
      />
    </div>
  </div>

  <!-- 样本列表表格 -->
  <div class="table-responsive">
    <table
      id="samples-table"
      class="table table-striped table-hover align-middle"
    >
      <thead class="table-light">
        <tr>
          {% for h in headers %}
          <th scope="col">{{ h }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {# 期望后端传入一个列表变量 samples（元素为 dict 或对象），示例结构:
        samples = [ {'chip_id': 'CHIP001', 'run_time': '2025-11-10 08:00',
        'split_status': '已拆分'}, ... ] #} {% if samples %} {% for s in samples
        %}
        <tr>
          <td>
            {{ s.get('chip_id', s.chip_id if s is not mapping and s is not none
            else '-') }}
          </td>
          <td>
            {{ s.get('run_time', s.run_time if s is not mapping and s is not
            none else '-') }}
          </td>
          <td>
            {{ s.get('split_status', s.split_status if s is not mapping and s is
            not none else '-') }}
          </td>
          <td>
            <!-- 删除按钮：使用表单 POST 到后端删除路由（需要在后端实现 molecular.delete_sample） -->
            <form
              method="post"
              action="{{ url_for('molecular.delete_sample') }}"
              class="d-inline"
            >
              {% if csrf_token is defined %}
              <input
                type="hidden"
                name="csrf_token"
                value="{{ csrf_token() }}"
              />
              {% endif %}
              <input
                type="hidden"
                name="chip_id"
                value="{{ s.get('chip_id') if s is mapping else s.chip_id }}"
              />
              <button
                type="submit"
                class="btn btn-sm btn-danger"
                onclick="return confirm('确认删除芯片 {{ s.get('chip_id') if s is mapping else s.chip_id }} ?');"
              >
                删除
              </button>
            </form>
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr class="table-warning">
          <td
            colspan="{{ headers|length if headers else 1 }}"
            class="text-center text-muted"
          >
            暂无数据
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- 简单的前端搜索（客户端过滤表格行） -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('table-search');
    const table = document.getElementById('samples-table');
    if (!table || !input) return;
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody ? tbody.rows : []);

    input.addEventListener('input', function () {
      const q = this.value.trim().toLowerCase();
      let visible = 0;

      rows.forEach(r => {
        // 如果该行是提示行（没有数据），跳过处理
        if (r.classList.contains('table-warning') && r.querySelector('td') && r.querySelector('td').getAttribute('colspan')) {
          r.style.display = q ? 'none' : '';
          if (!q) visible++;
          return;
        }

        const text = r.textContent.toLowerCase();
        if (q === '' || text.indexOf(q) !== -1) {
          r.style.display = '';
          visible++;
        } else {
          r.style.display = 'none';
        }
      });

      // 没有匹配时，显示一行提示
      const existingNo = tbody.querySelector('.no-results');
      if (visible === 0) {
        if (!existingNo) {
          const tr = document.createElement('tr');
          tr.className = 'no-results';
          const td = document.createElement('td');
          td.colSpan = {{ headers|length if headers else 1 }};
          td.className = 'text-center text-muted';
          td.textContent = '没有找到匹配项';
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      } else {
        if (existingNo) existingNo.remove();
      }
    });
  });
</script>
{% endblock %}
